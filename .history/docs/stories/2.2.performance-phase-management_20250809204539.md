# Story 2.2: Implement Performance Phase Management

## Status
- In Progress

## Story
As a Magician-Developer, I want the application to manage a configurable sequence of performance phases, so that I can customize which parts of the show to run for a specific performance.

## Acceptance Criteria
1. The application's core state is expanded to include `current_phase`, initialized to the first phase in the configured sequence. [Source: docs/prd.md#story-22-implement-performance-phase-management]
2. A new section is added to `config.yaml` to define the active sequence of phases (e.g., `performance_plan: [1, 3, 5]`). [Source: docs/prd.md#story-22-implement-performance-phase-management]
3. The application loads this `performance_plan` on startup. [Source: docs/prd.md#story-22-implement-performance-phase-management]
4. The system can correctly identify the current phase and determine the next phase based on the `performance_plan`. [Source: docs/prd.md#story-22-implement-performance-phase-management]

## Tasks / Subtasks
- [ ] Extend configuration (AC: 2–3)
  - [ ] Add `performance_plan: [1]` (default) to `corindagpt/config/config.yaml` [Source: docs/architecture.md#10.-source-tree]
  - [ ] Load `performance_plan` via `utils/initialization.load_config` on startup [Source: docs/architecture.md#5.-components]
  - [ ] Validate: non-empty list of integers; log error and fall back to `[1]` if invalid [Source: docs/architecture.md#12.-error-handling-strategy]
- [ ] Core state data structure (AC: 1)
  - [ ] Create `src/components/state.py` or extend the new `StateMachine` to carry `current_phase: int`
  - [ ] Initialize `current_phase = performance_plan[0]` on startup [Source: docs/architecture.md#2.-high-level-architecture]
  - [ ] Expose helpers: `get_current_phase() -> int`, `get_next_phase() -> Optional[int]`
- [ ] Integration in main loop (AC: 3–4)
  - [ ] During startup in `src/__main__.py`, read `performance_plan` and set `current_phase`
  - [ ] Provide a function `advance_phase_if_requested()` that uses `performance_plan` to compute the next phase and update `current_phase`
  - [ ] Log `current_phase` on startup and whenever it changes [Source: docs/architecture.md#13.-coding-standards]
- [ ] Project structure and config notes
  - [ ] No new external deps; keep async, non-blocking behavior [Source: docs/architecture.md#2.-high-level-architecture]
- [ ] Testing / Verification
  - [ ] Manual: set `performance_plan: [1,2,3]` and verify initial `current_phase=1`; simulate phase advances and verify progression to 2 then 3, then None/end
  - [ ] (Optional later) Unit tests for plan loading/validation and next-phase computation [Source: docs/architecture.md#14.-test-strategy-and-standards]

## Dev Notes
- Alignment with Architecture
  - Centralized config loaded at startup; avoid hardcoding [Source: docs/architecture.md#5.-components]
  - In-memory state is appropriate for a single-process asyncio app [Source: docs/architecture.md#2.-high-level-architecture]
  - File locations align with source tree (`src/components/`, `src/__main__.py`) [Source: docs/architecture.md#10.-source-tree]
- Error Handling
  - If `performance_plan` missing/invalid: log at `WARNING`, default to `[1]` [Source: docs/architecture.md#12.-error-handling-strategy]
- Logging & Standards
  - Use `logging`, no `print`; keep functions small and explicit [Source: docs/architecture.md#13.-coding-standards]

## Project Structure Notes
- Adds a small state/phase helper (either as part of the state machine or separate `state.py`). No deviations from the documented tree. [Source: docs/architecture.md#10.-source-tree]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-08 | 0.1 | Draft created from PRD and architecture. | Scrum Master |

## Dev Agent Record

### Completion Notes List
- N/A (draft)

### QA Results
- N/A (draft)

## Story Draft Checklist Validation

- [x] Goal & Context Clarity
- [x] Technical Implementation Guidance
- [x] Reference Effectiveness
- [x] Self-Containment Assessment
- [x] Testing Guidance

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY

- Sufficient context and references for implementation; no blockers identified.
