# Story 2.5: LLM-Driven Phase Transition via Function Calling

## Status
- In Review

## Story
As a Magician-Developer, I want the LLM to detect specific control phrases and trigger phase transitions via function calling, so that I can advance phases hands-free during a headless performance.

## Acceptance Criteria
1. The GPT service exposes a function/tool schema (e.g., `set_phase`) to the LLM with arguments to `advance` or `set` a specific phase. [Source: docs/prd.md#functional-requirements FR2; docs/architecture.md#6.-external-apis]
2. When the LLM returns a function/tool call indicating a phase transition, the app invokes `PhaseManager` to advance or set the phase and immediately reloads the corresponding prompt. [Source: docs/architecture.md#5.-components]
3. A configuration toggle (e.g., `transitions.llm_phase_control.enabled`) controls whether LLM-driven transitions are active. [Source: docs/architecture.md#5.-components]
4. Optional: configurable trigger phrases (e.g., `transitions.llm_phase_control.keyphrases`) are included in the system/instructions prompt so the LLM knows when to call the tool; absence of keywords should still allow the LLM to rely on natural-language intent. [Source: docs/architecture.md#3.-tech-stack]
5. On phase change, the system logs a confirmation (e.g., `Phase transitioned to {phase}`) and ignores further transition calls if already at the end of the `performance_plan`. [Source: docs/prd.md#story-24-phase-transition-logic]

## Tasks / Subtasks
- [x] Configuration (AC: 3–4)
  - [x] Extend `corindagpt/config/config.yaml` with:
    - [x] `transitions.llm_phase_control.enabled: false`
    - [x] `transitions.llm_phase_control.keyphrases: ["next phase", "advance phase", "switch to phase {n}"]`
  - [x] Load via initialization utilities [Source: docs/architecture.md#5.-components]
- [x] GPT function schema (AC: 1)
  - [x] In `src/services/gpt.py`, define tool/function schema for `set_phase` with params:
    - [x] `action: "advance" | "set"`
    - [x] `phase: int` (required when `action == "set"`)
  - [x] Include this schema in chat requests when `llm_phase_control.enabled=true`
- [ ] Prompt instructions (AC: 1, 4)
  - [ ] Add system/instructions content guiding the LLM: when the user says control phrases (or intent to change phase), call `set_phase` accordingly
  - [ ] If keywords configured, include them; otherwise rely on natural-language detection
- [ ] Tool-call handling (AC: 2, 5)
  - [ ] In GPT response handling, detect `tool_calls`
  - [ ] On `set_phase`:
    - [ ] If `action == advance`, call `PhaseManager.advance()`
    - [ ] If `action == set`, call `PhaseManager.set(phase)` (add method) with bounds-checking
    - [ ] Immediately load the new phase’s prompt
    - [ ] Log `Phase transitioned to {phase}` (or `No further phases` when at end)
- [ ] Safeguards
  - [ ] Only honor tool calls when `llm_phase_control.enabled=true`
  - [ ] Ignore malformed requests; log warnings
- [ ] Verification
  - [ ] Manual: Speak “next phase”, observe function call and transition; speak “switch to phase 3”, observe set and prompt load
  - [ ] Edge cases: already at last phase; invalid phase index; feature disabled toggle

## Dev Notes
- Alignment with PRD & Architecture
  - FR2 allows phase transitions via discreet inputs or keyword detection by the LLM; this story implements the latter via OpenAI function calling. [Source: docs/prd.md#functional-requirements]
  - Integrates with existing `PhaseManager` and prompt loader (from 2.2, 2.3). [Source: docs/architecture.md#5.-components]
- Technical Approach
  - Use OpenAI tool/function calling (chat completion with `tools`) to receive structured requests to change phase. [Source: docs/architecture.md#6.-external-apis]
  - Keep all I/O async (`httpx`), and ensure handlers do not block the main loop. [Source: docs/architecture.md#3.-tech-stack; #2.-high-level-architecture]
- File Locations
  - `src/services/gpt.py`: add tool schema and response handling
  - `src/components/phase_manager.py`: add `set(phase: int)` and existing `advance()`
  - `src/__main__.py`: wire handling path for tool calls
  - `corindagpt/config/config.yaml`: add `transitions.llm_phase_control` section [Source: docs/architecture.md#10.-source-tree]
- Logging & Standards
  - Use `logging`; explicit exception handling; no prints. [Source: docs/architecture.md#13.-coding-standards]

## Project Structure Notes
- Story extends existing services and components without structural conflicts. [Source: docs/architecture.md#10.-source-tree]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-08 | 0.1 | Draft created from PRD and architecture. | Scrum Master |
| 2025-08-10 | 0.2 | Added config, tool schema scaffolding; remaining: tool-call handling and instructions. | Dev Agent |

## Story Draft Checklist Validation

- [x] Goal & Context Clarity
- [x] Technical Implementation Guidance
- [x] Reference Effectiveness
- [x] Self-Containment Assessment
- [x] Testing Guidance

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY

- The story provides sufficient guidance to implement LLM-driven phase control with function calling and integrates cleanly with the existing architecture.
