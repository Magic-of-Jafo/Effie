# Story 3.1: Develop Abstract Input Handler

## Status
- In Progress

## Story
As a Magician-Developer, I want a dedicated input handler that can distinguish between different physical input patterns (brief, sustained, compound), so that the application can trigger different actions from a single input source.

## Acceptance Criteria
1. A new input handler module is created that can reliably detect and differentiate between a "brief input" (e.g., a quick press), a "sustained input" (e.g., press and hold), and a "compound input" (e.g., double press and hold). [Source: docs/prd.md#story-31-develop-abstract-input-handler]
2. The time durations that define these patterns (e.g., the threshold for a "sustained" press) are configurable in `config.yaml`. [Source: docs/prd.md#story-31-develop-abstract-input-handler]
3. The `main.py` event loop is refactored to receive abstract events from this handler (e.g., `BRIEF_INPUT_DETECTED`) instead of directly checking for keyboard presses. [Source: docs/prd.md#story-31-develop-abstract-input-handler]
4. The handler is designed to be independent of the physical hardware, allowing for future integration with custom sensors or buttons without changing the core application logic. [Source: docs/prd.md#story-31-develop-abstract-input-handler]

## Tasks / Subtasks
- [x] Configuration (AC: 2)
  - [x] Add `input_patterns` to `corindagpt/config/config.yaml`:
    - [x] `brief_max_ms` (e.g., 250)
    - [x] `sustained_min_ms` (e.g., 600)
    - [x] `compound_double_press_window_ms` (e.g., 350)
    - [x] `hotkey` (default: `f12`) and `enabled_sources: ["keyboard"]`
  - [x] Load via existing initialization utilities [Source: docs/architecture.md#5.-components]
- [x] Implement abstract handler (AC: 1, 4)
  - [x] Create `src/components/abstract_input_handler.py` with:
    - [x] `InputPattern = Enum('BRIEF','SUSTAINED','COMPOUND')`
    - [x] `InputEvent` dataclass: `{ pattern: InputPattern, timestamp: float, meta: dict }`
    - [x] `AbstractInputHandler` interface with `start()`, `stop()`, and `on_event: Callable[[InputEvent], Awaitable[None]]`
    - [x] `KeyboardInputSource` (initial implementation) using the configured hotkey, translating raw press/release into high-level events using thresholds
    - [x] Non-blocking scheduling (use `asyncio` timers) and precise press-duration tracking
  - [x] Ensure the module is hardware-agnostic (source plug-in pattern), so future sources (e.g., GPIO) can be added without changing consumers [Source: docs/architecture.md#2.-high-level-architecture]
- [x] Main loop integration (AC: 3)
  - [x] Update `src/__main__.py` to instantiate `AbstractInputHandler` with `KeyboardInputSource`
  - [x] Replace direct press/release wiring with callbacks receiving `InputEvent`
  - [x] Temporarily map events to logs or no-ops; mapping to workflows will be completed in Story 3.2
- [x] Diagnostics & Logging (AC: 1â€“4)
  - [x] Log detected pattern, press duration, and timing windows using `logging` [Source: docs/architecture.md#13.-coding-standards]
- [ ] Verification
  - [ ] Manual: Validate that quick tap -> BRIEF, press/hold -> SUSTAINED, double-tap+hold -> COMPOUND
  - [ ] Confirm thresholds adjust behavior via `config.yaml`

## Dev Notes
- Architecture Alignment
  - Introduces an abstract input layer delivering semantic events to the main loop, decoupled from hardware specifics. [Source: docs/architecture.md#2.-high-level-architecture]
  - File locations are aligned with the source tree (`src/components/...`, `src/__main__.py`). [Source: docs/architecture.md#10.-source-tree]
- Non-Blocking Behavior
  - Use `asyncio` timers and the existing event loop for measuring durations; avoid blocking calls. [Source: docs/architecture.md#2.-high-level-architecture]
- Configuration
  - Centralized in YAML; thresholds configurable and loaded once on startup. [Source: docs/architecture.md#5.-components]
- Future Integration (Story 3.2)
  - Map BRIEF -> audio queue playback; SUSTAINED -> full pipeline; COMPOUND -> pipeline bypassing decoder. [Source: docs/prd.md#story-32-integrate-input-patterns-with-core-workflows]

## Project Structure Notes
- Adds new component `src/components/abstract_input_handler.py` and refactors `src/__main__.py` to consume abstract events; does not conflict with existing `input_handler.py` (which can be deprecated after migration).

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-08 | 0.1 | Draft created from PRD and architecture. | Scrum Master |
| 2025-08-10 | 0.2 | Added abstract input handler module and configuration scaffolding. | Dev Agent |
| 2025-08-10 | 0.3 | Integrated abstract handler into main loop with diagnostic logging. | Dev Agent |

## Story Draft Checklist Validation

- [x] Goal & Context Clarity
- [x] Technical Implementation Guidance
- [x] Reference Effectiveness
- [x] Self-Containment Assessment
- [x] Testing Guidance

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY

- The story provides sufficient guidance to implement an abstract, configurable input handler aligned with Epic 3 and the architecture.
