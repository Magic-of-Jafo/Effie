# Story 2.4: Phase Transition Logic

## Status
- In Review

## Story
As a Magician, I want to be able to transition to the next phase of the performance using a discreet input, so that I can control the show's progression live on stage.

## Acceptance Criteria
1. A specific, configurable input pattern (e.g., a long press held for 3 seconds) is defined to trigger a phase transition. [Source: docs/prd.md#story-24-phase-transition-logic]
2. When this input is detected, the application advances to the next phase as defined in the `performance_plan` from the configuration file. [Source: docs/prd.md#story-24-phase-transition-logic]
3. Upon transition, the `current_phase` state is updated, and the new prompt for that phase is immediately loaded. [Source: docs/prd.md#story-24-phase-transition-logic; docs/prd.md#story-23-dynamic-prompt-loading-with-langchain]
4. A confirmation of the phase change (e.g., "Phase transitioned to 3") is logged to the console. [Source: docs/prd.md#story-24-phase-transition-logic]
5. If the last phase in the `performance_plan` is reached, subsequent transition triggers will not change the phase further. [Source: docs/prd.md#story-24-phase-transition-logic]

## Tasks / Subtasks
- [x] Configuration (AC: 1–2)
  - [x] Extend `corindagpt/config/config.yaml` with a `transitions` section:
    - [x] `phase_transition`: `{ hotkey: "f11" (or button id), long_press_ms: 3000 }`
    - [x] Confirm `performance_plan` exists (from Story 2.2); if absent, add placeholder `[1,2,3,4,5]`
  - [x] Load settings via existing initialization utilities [Source: docs/architecture.md#5.-components]
- [x] Implement Phase Manager (AC: 2–3, 5)
  - [x] Create `src/components/phase_manager.py` with:
    - [x] `performance_plan: List[int]`, `current_index: int`, `current_phase: int`
    - [x] `advance()` that increments `current_index` if not at end, returns new `current_phase`, else returns same
    - [x] `load_prompt_for_current_phase()` that invokes the prompt loader (from 2.3) [Source: docs/architecture.md#5.-components]
  - [x] Log phase value on change via `logging` [Source: docs/architecture.md#13.-coding-standards]
- [x] Input pattern detection (AC: 1–2)
  - [x] Update input handling to detect configured long press (e.g., start timer on press of `f11`, cancel on release; if held >= `long_press_ms`, trigger transition)
  - [x] Add non-blocking scheduling using the existing event loop [Source: docs/architecture.md#2.-high-level-architecture]
- [x] Integrate in main loop (AC: 2–4, 5)
  - [x] Instantiate `PhaseManager` on startup; initialize from `performance_plan` [Source: docs/architecture.md#10.-source-tree]
  - [x] Wire long-press handler to call `phase_manager.advance()`; immediately call `load_prompt_for_current_phase()`
  - [x] Log confirmation message (e.g., `Phase transitioned to {phase}`)
  - [x] If last phase already active, do nothing beyond logging a notice
- [ ] Verification (AC: 1–5)
  - [ ] Manual: Observe logs while holding the configured hotkey for the configured duration; confirm phase increments and prompt load
  - [ ] Edge cases: verify no change when already at end-of-plan; verify early release (< threshold) does not trigger

## Dev Notes
- Architecture Alignment
  - State machine and main event loop orchestrate transitions; this story adds phase advancement and prompt reload on a discrete input [Source: docs/architecture.md#2.-high-level-architecture; #7.-core-workflows]
  - Source tree placement: `src/components/phase_manager.py`, wiring in `src/__main__.py`, input logic in `src/components/input_handler.py` [Source: docs/architecture.md#10.-source-tree]
- Prompt Management
  - Prompt loading is handled via `langchain-core` PromptTemplate (from Story 2.3); this story calls it on phase change [Source: docs/architecture.md#3.-tech-stack]
- Configuration
  - Centralized YAML; new `transitions.phase_transition` settings read through initialization loader [Source: docs/architecture.md#5.-components]
- Logging & Standards
  - Use `logging`, no `print`; maintain non-blocking `asyncio` behavior [Source: docs/architecture.md#13.-coding-standards]

## Project Structure Notes
- Adds `src/components/phase_manager.py` and modifies `src/__main__.py` and `src/components/input_handler.py` per architecture source tree [Source: docs/architecture.md#10.-source-tree]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-08 | 0.1 | Draft created from PRD and architecture. | Scrum Master |
| 2025-08-10 | 0.2 | Implemented long-press transition, PhaseManager, and main loop integration. | Dev Agent |

## Story Draft Checklist Validation

- [x] Goal & Context Clarity
- [x] Technical Implementation Guidance
- [x] Reference Effectiveness
- [x] Self-Containment Assessment
- [x] Testing Guidance

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY

- The story provides sufficient context for implementation, references the PRD and Architecture, and defines verifiable outcomes.
