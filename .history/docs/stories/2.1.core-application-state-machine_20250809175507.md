# Story 2.1: Implement Core Application State Machine

## Status
- In Review

## Story
As a Magician-Developer, I want a simple state machine to manage the application's operational status (e.g., IDLE, LISTENING, PROCESSING), so that the application can handle different operations sequentially and without conflicts.

## Acceptance Criteria
1. A state machine is implemented with at least three states: `IDLE`, `LISTENING`, and `PROCESSING`. [Source: docs/prd.md#story-21-implement-core-application-state-machine]
2. The application correctly starts in the `IDLE` state. [Source: docs/prd.md#story-21-implement-core-application-state-machine]
3. The audio capture logic transitions the state from `IDLE` to `LISTENING`. [Source: docs/prd.md#story-21-implement-core-application-state-machine]
4. After audio is successfully captured, the state transitions from `LISTENING` to `PROCESSING`. [Source: docs/prd.md#story-21-implement-core-application-state-machine]
5. After the full response pipeline is complete (TTS audio finishes playing), the state returns to `IDLE`. [Source: docs/prd.md#story-21-implement-core-application-state-machine]
6. The current state is logged to the console during every transition for debugging purposes. [Source: docs/prd.md#story-21-implement-core-application-state-machine]

## Tasks / Subtasks
- [ ] Create state machine component (AC: 1–2)
  - [ ] Add `src/components/state_machine.py` with:
    - [ ] An `Enum` or `Literal` for `IDLE`, `LISTENING`, `PROCESSING`
    - [ ] A `StateMachine` class with `current_state`, `transition(next_state: State)` and optional guards
    - [ ] `on_transition` callback hook to emit logs
  - [ ] Initialize default state to `IDLE`
  - [ ] Use `logging` per coding standards [Source: docs/architecture.md#13.-coding-standards]
- [ ] Integrate with main loop (AC: 3–6)
  - [ ] Instantiate `StateMachine` in `src/__main__.py` [Source: docs/architecture.md#10.-source-tree]
  - [ ] On F12 press (start recording), transition `IDLE -> LISTENING` [Source: docs/architecture.md#7.-core-workflows]
  - [ ] On F12 release (buffer ready), transition `LISTENING -> PROCESSING`
  - [ ] After TTS playback completes, transition `PROCESSING -> IDLE`
  - [ ] Log each transition via the state machine hook [Source: docs/architecture.md#2.-high-level-architecture]
- [ ] Minimal playback completion signal (AC: 5)
  - [ ] Ensure TTS `play(...)` returns/awaits on completion so the main loop can transition back to `IDLE` [Source: docs/architecture.md#7.-core-workflows]
- [ ] Configuration and structure checks
  - [ ] No new config required for states; confirm alignment with source tree [Source: docs/architecture.md#10.-source-tree]
- [ ] Testing / Verification
  - [ ] Manual: Observe logs for transitions across a full cycle (IDLE→LISTENING→PROCESSING→IDLE)
  - [ ] (Optional for later) Unit tests for `StateMachine.transition` and integration with input/tts [Source: docs/architecture.md#14.-test-strategy-and-standards]

## Dev Notes
- Alignment with Architecture
  - The application is a single, stateful `asyncio` process. The state machine resides in-memory and coordinates the core loop. [Source: docs/architecture.md#2.-high-level-architecture]
  - File location per source tree: `src/components/state_machine.py`; integration in `src/__main__.py`. [Source: docs/architecture.md#10.-source-tree]
  - Integration touchpoints: Input Handler (press/release), Voice to Text (buffer ready), GPT/TTS (processing complete). [Source: docs/architecture.md#5.-components]
- Logging & Standards
  - Use `logging` (no print), explicit exception handling; retain non-blocking `asyncio` behavior. [Source: docs/architecture.md#13.-coding-standards]
- Core Workflow Mapping
  - Sustained input path: Record -> Transcribe -> (Decode future) -> LLM -> TTS -> Playback; transitions wrap these phases. [Source: docs/architecture.md#7.-core-workflows]
- Testing Strategy
  - Follow test-after pattern; for this story, manual verification is sufficient; unit/integration tests can be added in a later wave. [Source: docs/architecture.md#14.-test-strategy-and-standards]

## Project Structure Notes
- Story introduces `src/components/state_machine.py` referenced by architecture; no conflicts with current layout. [Source: docs/architecture.md#10.-source-tree]

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-08-08 | 0.1 | Draft created from PRD and architecture. | Scrum Master |

## Dev Agent Record

### Completion Notes List
- N/A (draft)

### QA Results
- N/A (draft)

## Story Draft Checklist Validation

- [x] Goal & Context Clarity
- [x] Technical Implementation Guidance
- [x] Reference Effectiveness
- [x] Self-Containment Assessment
- [x] Testing Guidance

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY

- The story provides sufficient context for implementation and integrates with the existing architecture and codebase. No blockers identified.
